"use strict";(self.webpackChunkreference_docs=self.webpackChunkreference_docs||[]).push([[95073],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(67294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,s=function(e,t){if(null==e)return{};var a,n,s={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(a),d=s,m=p["".concat(l,".").concat(d)]||p[d]||h[d]||r;return a?n.createElement(m,o(o({ref:t},c),{},{components:a})):n.createElement(m,o({ref:t},c))}));function m(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=a.length,o=new Array(r);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[p]="string"==typeof e?e:s,o[1]=i;for(var u=2;u<r;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},32786:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>i,toc:()=>u});var n=a(87462),s=(a(67294),a(3905));const r={id:"auth-policies",title:"Part Three: Policies",description:"Supabase Auth Deep Dive Part 3: User Based Access Policies"},o=void 0,i={unversionedId:"learn/auth-deep-dive/auth-policies",id:"learn/auth-deep-dive/auth-policies",title:"Part Three: Policies",description:"Supabase Auth Deep Dive Part 3: User Based Access Policies",source:"@site/docs/learn/auth-deep-dive/policies.md",sourceDirName:"learn/auth-deep-dive",slug:"/learn/auth-deep-dive/auth-policies",permalink:"/docs/learn/auth-deep-dive/auth-policies",draft:!1,editUrl:"https://github.com/docs/learn/auth-deep-dive/policies.md",tags:[],version:"current",frontMatter:{id:"auth-policies",title:"Part Three: Policies",description:"Supabase Auth Deep Dive Part 3: User Based Access Policies"}},l={},u=[{value:"About",id:"about",level:3},{value:"Watch",id:"watch",level:3},{value:"User based row level policies",id:"user-based-row-level-policies",level:3},{value:"Resources",id:"resources",level:3},{value:"Next steps",id:"next-steps",level:3}],c={toc:u};function p(e){let{components:t,...a}=e;return(0,s.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h3",{id:"about"},"About"),(0,s.kt)("p",null,"How to restrict table access to authenticated users, row level policies, and email domain based access."),(0,s.kt)("h3",{id:"watch"},"Watch"),(0,s.kt)("div",{class:"video-container"},(0,s.kt)("iframe",{src:"https://www.youtube-nocookie.com/embed/0LvCOlELs5U",frameBorder:"1",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0})),(0,s.kt)("h3",{id:"user-based-row-level-policies"},"User based row level policies"),(0,s.kt)("p",null,"Now that we know how to restrict access to tables based on JWT roles, we can combine this with user management to give us much more control over what data your users can read to and write from your database."),(0,s.kt)("p",null,"We'll start with how user sessions work in Supabase, and later move on to writing user-centric policies."),(0,s.kt)("p",null,"Let's say we're signing a user up to our service for the first time. The typical way to do this is by invoking the following method in supabase-js:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// see full api reference here: /docs/reference/javascript/auth-signup\nsupabase.auth.signUp({ email, password })\n")),(0,s.kt)("p",null,"By default this will send a confirmation email to the user. When the user clicks the link in the email, they will be redirected to your site (you need to provide your site url in Auth > Settings on the dashboard. By default this is http://localhost:3000) and the full URL including query params will look something like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"http://localhost:3000/#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjE2NDI5MDY0LCJzdWIiOiI1YTQzNjVlNy03YzdkLTRlYWYtYThlZS05ZWM5NDMyOTE3Y2EiLCJlbWFpbCI6ImFudEBzdXBhYmFzZS5pbyIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIn0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.4IFzn4eymqUNYYo2AHLxNRL8m08G93Qcg3_fblGqDjo&expires_in=3600&refresh_token=RuioJv2eLV05lgH5AlJwTw&token_type=bearer&type=signup\n")),(0,s.kt)("p",null,"Let's break this up so that it's easier to read:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// the base url - whatever you set in the Auth Settings in app.supabase.com dashboard\nhttp://localhost:3000/\n\n// note we use the '#' (fragment) instead of '?' query param\n// the access token is a JWT issued to the user\n#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjE2NDI5MDY0LCJzdWIiOiI1YTQzNjVlNy03YzdkLTRlYWYtYThlZS05ZWM5NDMyOTE3Y2EiLCJlbWFpbCI6ImFudEBzdXBhYmFzZS5pbyIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIn0sInVzZXJfbWV0YWRhdGEiOnt9LCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.4IFzn4eymqUNYYo2AHLxNRL8m08G93Qcg3_fblGqDjo\n\n// valid for 60 minutes by default\n&expires_in=3600\n\n// use to get a new access_token before 60 minutes expires\n&refresh_token=RuioJv2eLV05lgH5AlJwTw\n\n// can use as the Authorization: Bearer header in requests to your API\n&token_type=bearer\n\n// why was this token issued? was it a signup, login, password reset, or magic link?\n&type=signup\n")),(0,s.kt)("p",null,"If we put the access_token into ",(0,s.kt)("a",{parentName:"p",href:"https://jwt.io"},"https://jwt.io")," we'll see it decodes to:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},'{\n  "aud": "authenticated",\n  "exp": 1616429064,\n  "sub": "5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca",\n  "email": "ant@supabase.io",\n  "app_metadata": {\n    "provider": "email"\n  },\n  "user_metadata": {},\n  "role": "authenticated"\n}\n')),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"authenticated")," role is special in Supabase, it tells the API that this is an authenticated user and will know to compare the JWT against any policies you've added to the requested resource (table or row)."),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"sub")," claim is usually what we use to match the JWT to rows in your database, since by default it is the unique identifier of the user in the ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.users")," table (as a side note - it's generally not recommended to alter the ",(0,s.kt)("inlineCode",{parentName:"p"},"auth")," schema in any way in your Supabase database since the Auth API relies on it to function correctly)."),(0,s.kt)("p",null,"For the curious, try heading to the SQL editor and querying:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},"select * from auth.users;\n")),(0,s.kt)("p",null,"If supabase-js is loaded on your site (in this case http://localhost:3000) it automatically plucks the ",(0,s.kt)("inlineCode",{parentName:"p"},"access_token")," out of the URL and initiates a session. You can retrieve the ",(0,s.kt)("a",{parentName:"p",href:"/docs/reference/javascript/auth-getsession"},"session")," to see if there is a valid session:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"console.log(supabase.auth.getSession())\n")),(0,s.kt)("p",null,"Now that we can use methods to issue JWTs to users, we want to start fetching resources specific to that user. So let's make some. Go to the SQL editor and run:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},"create table my_scores (\n    name text,\n    score int,\n    user_id uuid not null\n);\n\nALTER TABLE my_scores ENABLE ROW LEVEL SECURITY;\n\ninsert into my_scores(name, score, user_id)\nvalues\n  ('Paul', 100, '5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca'),\n  ('Paul', 200, '5a4365e7-7c7d-4eaf-a8ee-9ec9432917ca'),\n  ('Leto', 50,  '9ec94326-2e2d-2ea2-22e3-3a535a4365e7');\n\n-- use UUIDs from the auth.users table if you want to try it\n-- for yourself\n")),(0,s.kt)("p",null,"Now we'll write our policy, again in SQL, but note it's also possible to add via the dashboard in Auth > Policies:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE POLICY user_update_own_scores ON my_scores\n    FOR ALL\n    USING (auth.uid() = user_id);\n")),(0,s.kt)("p",null,"Now, assuming you have an active session in your javascript/supabase-js environment you can do:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"supabase.from('my_scores').select('*').then(console.log)\n")),(0,s.kt)("p",null,"and you should only receive scores belonging to the current logged in user. Alternatively you can use Bash like:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl \'https://sjvwsaokcugktsdaxxze.supabase.co/rest/v1/my_scores?select=*\' \\\n-H "apikey: <ANON_KEY>" \\\n-H "Authorization: Bearer <ACCESS_TOKEN>"\n')),(0,s.kt)("p",null,"Note that the ",(0,s.kt)("inlineCode",{parentName:"p"},"anon key")," (or ",(0,s.kt)("inlineCode",{parentName:"p"},"service role key"),") is always needed to get past the API gateway. This can be passed in the ",(0,s.kt)("inlineCode",{parentName:"p"},"apikey")," header or in a query param named ",(0,s.kt)("inlineCode",{parentName:"p"},"apikey"),". It is passed automatically in supabase-js as long as you used it to instantiate the client."),(0,s.kt)("p",null,"There are some more notes here on how to structure your schema to best integrate with the ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.users")," table."),(0,s.kt)("p",null,"Once you get the hang of policies you can start to get a little bit fancy. Let's say I work at Blizzard and I only want Blizzard staff members to be able to update people's high scores, I can write something like:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},"create policy \"Only Blizzard staff can update leaderboard\"\n  on my_scores\n  for update using (\n    right(auth.jwt() ->> 'email', 13) = '@blizzard.com'\n  );\n")),(0,s.kt)("p",null,"Supabase comes with two built-in helper functions: ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.uid()")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.jwt()"),"."),(0,s.kt)("p",null,"See the full PostgreSQL policy docs here: ",(0,s.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/12/sql-createpolicy.html"},"https://www.postgresql.org/docs/12/sql-createpolicy.html")),(0,s.kt)("p",null,"You can get as creative as you like with these policies."),(0,s.kt)("h3",{id:"resources"},"Resources"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"JWT debugger: ",(0,s.kt)("a",{parentName:"li",href:"https://jwt.io%E2%80%8B"},"https://jwt.io\u200b")),(0,s.kt)("li",{parentName:"ul"},"PostgeSQL Policies: ",(0,s.kt)("a",{parentName:"li",href:"https://www.postgresql.org/docs/12/sql-createpolicy.html"},"https://www.postgresql.org/docs/12/sql-createpolicy.html")),(0,s.kt)("li",{parentName:"ul"},"PostgREST Row Level Security: ",(0,s.kt)("a",{parentName:"li",href:"https://postgrest.org/en/v7.0.0/auth.html"},"https://postgrest.org/en/v7.0.0/auth.html"))),(0,s.kt)("h3",{id:"next-steps"},"Next steps"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Watch ",(0,s.kt)("a",{parentName:"li",href:"../../learn/auth-deep-dive/auth-deep-dive-jwts"},"Part One: JWTs")),(0,s.kt)("li",{parentName:"ul"},"Watch ",(0,s.kt)("a",{parentName:"li",href:"../../learn/auth-deep-dive/auth-row-level-security"},"Part Two: Row Level Security")),(0,s.kt)("li",{parentName:"ul"},"Watch ",(0,s.kt)("a",{parentName:"li",href:"../../learn/auth-deep-dive/auth-gotrue"},"Part Four: GoTrue")),(0,s.kt)("li",{parentName:"ul"},"Watch ",(0,s.kt)("a",{parentName:"li",href:"../../learn/auth-deep-dive/auth-google-oauth"},"Part Five: Google Oauth")),(0,s.kt)("li",{parentName:"ul"},"Sign up for Supabase: ",(0,s.kt)("a",{parentName:"li",href:"https://app.supabase.com"},"app.supabase.com"))))}p.isMDXComponent=!0}}]);