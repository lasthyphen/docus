"use strict";(self.webpackChunkreference_docs=self.webpackChunkreference_docs||[]).push([[84820],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(67294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,o=e.originalType,l=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),u=p(n),h=s,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||o;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var o=n.length,i=new Array(o);i[0]=h;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r[u]="string"==typeof e?e:s,i[1]=r;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},32933:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>p});var a=n(87462),s=(n(67294),n(3905));const o={id:"stytch",title:"Stytch",description:"Build a Next.js application powered by password-less authentication from Stytch, and Supabase's Row Level Security (RLS)."},i=void 0,r={unversionedId:"guides/integrations/stytch",id:"guides/integrations/stytch",title:"Stytch",description:"Build a Next.js application powered by password-less authentication from Stytch, and Supabase's Row Level Security (RLS).",source:"@site/docs/guides/integrations/stytch.mdx",sourceDirName:"guides/integrations",slug:"/guides/integrations/stytch",permalink:"/docs/guides/integrations/stytch",draft:!1,editUrl:"https://github.com/docs/guides/integrations/stytch.mdx",tags:[],version:"current",frontMatter:{id:"stytch",title:"Stytch",description:"Build a Next.js application powered by password-less authentication from Stytch, and Supabase's Row Level Security (RLS)."}},l={},p=[{value:"Step 0: Create a Stytch Account",id:"step-0-create-a-stytch-account",level:2},{value:"Step 1: Set up Stytch redirect URLs",id:"step-1-set-up-stytch-redirect-urls",level:2},{value:"Step 2: Create a Supabase project",id:"step-2-create-a-supabase-project",level:2},{value:"Step 3: Creating data in Supabase",id:"step-3-creating-data-in-supabase",level:2},{value:"Step 4: Building a Next.js app",id:"step-4-building-a-nextjs-app",level:2},{value:"Step 5: Build the Login Form",id:"step-5-build-the-login-form",level:2},{value:"Step 6: Authenticate and start a session",id:"step-6-authenticate-and-start-a-session",level:2},{value:"Step 7: Requesting user data from Supabase",id:"step-7-requesting-user-data-from-supabase",level:2},{value:"Step 8: Write a policy to allow select",id:"step-8-write-a-policy-to-allow-select",level:2},{value:"Optional: Add Google One Tap",id:"optional-add-google-one-tap",level:2},{value:"Resources",id:"resources",level:2}],c={toc:p};function u(e){let{components:t,...o}=e;return(0,s.kt)("wrapper",(0,a.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"In this guide we will build a simple expense tracker web application using Stytch, Supabase, and Next.js."),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://stytch.com?utm_source=supabase&utm_medium=guide"},"Stytch")," provides an all-in-one platform for passwordless auth. Stytch makes it easy for you to embed passwordless solutions into your websites and apps for better security, better conversion rates, and a better end user experience. Their easy-to-use SDKs and direct API access allows for maximum control and customization. In this example we will use ",(0,s.kt)("a",{parentName:"p",href:"https://stytch.com/products/email-magic-links?utm_source=supabase&utm_medium=guide"},"Email magic links")," to create and log in our users, and Session management. There is an additional, optional step to enable ",(0,s.kt)("a",{parentName:"p",href:"https://stytch.com/blog/improving-conversion-with-google-one-tap?utm_source=supabase&utm_medium=guide"},"Google One Tap")," which is an especially high-converting Google OAuth sign-up and login flow."),(0,s.kt)("p",null,"We will leverage Supabase to store and authorize access to user data. Supabase makes it simple to set up Row Level Security (RLS) policies which ensure users can only read and write data that they are authorized to do so. If you do not already have a Supabase account, you will need to create one."),(0,s.kt)("p",null,"This guide will use ",(0,s.kt)("a",{parentName:"p",href:"https://nextjs.org/"},"Next.js")," which is a web application framework built on top of React. Stytch provides a ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/stytchauth/stytch-node"},"Node.js library")," and a ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/stytchauth/stytch-react"},"React library")," which makes building Next.js apps super easy."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: You can find a completed version of this project on ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/stytchauth/stytch-nextjs-supabase"},"Github"),".")),(0,s.kt)("h2",{id:"step-0-create-a-stytch-account"},"Step 0: Create a Stytch Account"),(0,s.kt)("p",null,"If you already have a Stytch account you may skip this step."),(0,s.kt)("p",null,"Go to ",(0,s.kt)("a",{parentName:"p",href:"https://stytch.com?utm_source=supabase&utm_medium=guide"},"Stytch"),", and create an account. Note that Stytch provides two ways to create an account, either via Google OAuth, or through Email magic links.\xa0 This is the same user experience we will be building in this guide!"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Stytch redirect URL settings",src:n(31127).Z,width:"882",height:"1024"})),(0,s.kt)("h2",{id:"step-1-set-up-stytch-redirect-urls"},"Step 1: Set up Stytch redirect URLs"),(0,s.kt)("p",null,"First we need to add the redirect URLs that will be used during the Email magic link flow. This step helps ensure bad actors cannot spoof your magic links and hijack redirects."),(0,s.kt)("p",null,"Navigate to your ",(0,s.kt)("a",{parentName:"p",href:"https://stytch.com/dashboard/redirect-urls?utm_source=supabase&utm_medium=guide"},"redirect URL settings")," in the Stytch dashboard, and under ",(0,s.kt)("strong",{parentName:"p"},"Test environment")," create an entry where the ",(0,s.kt)("strong",{parentName:"p"},"URL")," is ",(0,s.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/api/authenticate")," and the ",(0,s.kt)("strong",{parentName:"p"},"Type")," is ",(0,s.kt)("inlineCode",{parentName:"p"},"All"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Edit Stytch redirect URL settings",src:n(88931).Z,width:"1408",height:"1226"})),(0,s.kt)("p",null,"After pressing ",(0,s.kt)("strong",{parentName:"p"},"Confirm"),", the redirect URLs dashboard will update to show your new entry. We will use this URL later on."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Stytch redirect URL settings",src:n(68711).Z,width:"1999",height:"950"})),(0,s.kt)("h2",{id:"step-2-create-a-supabase-project"},"Step 2: Create a Supabase project"),(0,s.kt)("p",null,"From your ",(0,s.kt)("a",{parentName:"p",href:"https://app.supabase.com/"},"Supabase dashboard"),", click ",(0,s.kt)("strong",{parentName:"p"},"New project"),"."),(0,s.kt)("p",null,"Enter a ",(0,s.kt)("inlineCode",{parentName:"p"},"Name")," for your Supabase project."),(0,s.kt)("p",null,"Enter a secure ",(0,s.kt)("inlineCode",{parentName:"p"},"Database Password"),"."),(0,s.kt)("p",null,"Click ",(0,s.kt)("strong",{parentName:"p"},"Create new project"),". It may take a couple minutes for your project to be provisioned."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"New Supabase project settings",src:n(831).Z,width:"1352",height:"1276"})),(0,s.kt)("h2",{id:"step-3-creating-data-in-supabase"},"Step 3: Creating data in Supabase"),(0,s.kt)("p",null,"Once your Supabase project is provisioned, click Table editor, then New table. This tool is available from the sidebar menu in the ",(0,s.kt)("a",{parentName:"p",href:"https://app.supabase.com/"},"Supabase dashboard"),"."),(0,s.kt)("p",null,"Enter ",(0,s.kt)("inlineCode",{parentName:"p"},"expenses")," as the ",(0,s.kt)("strong",{parentName:"p"},"Name")," field."),(0,s.kt)("p",null,"Select ",(0,s.kt)("inlineCode",{parentName:"p"},"Enable Row Level Security (RLS)"),"."),(0,s.kt)("p",null,"Add three new columns:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," as ",(0,s.kt)("inlineCode",{parentName:"p"},"text"))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("inlineCode",{parentName:"p"},"title")," as ",(0,s.kt)("inlineCode",{parentName:"p"},"text"))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("inlineCode",{parentName:"p"},"value")," as ",(0,s.kt)("inlineCode",{parentName:"p"},"float8")))),(0,s.kt)("p",null,"Click ",(0,s.kt)("strong",{parentName:"p"},"Save")," to create the new table."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Creating a new table",src:n(9197).Z,width:"1306",height:"1470"})),(0,s.kt)("p",null,"From the Table editor view, select the expenses table and click ",(0,s.kt)("strong",{parentName:"p"},"Insert row"),"."),(0,s.kt)("p",null,"Fill out the title and value fields (leave user_id blank for now) and click ",(0,s.kt)("strong",{parentName:"p"},"Save"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Creating a new row",src:n(45831).Z,width:"1336",height:"1616"})),(0,s.kt)("p",null,"Use ",(0,s.kt)("strong",{parentName:"p"},"Insert Row")," to further populate the table with expenses."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Multiple rows",src:n(2859).Z,width:"1904",height:"524"})),(0,s.kt)("h2",{id:"step-4-building-a-nextjs-app"},"Step 4: Building a Next.js app"),(0,s.kt)("p",null,"Using a terminal, create a new Next.js project:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npx create-next-app stytch-supabase-example\n")),(0,s.kt)("p",null,"Next, within ",(0,s.kt)("inlineCode",{parentName:"p"},"stytch-supabase-example")," create a ",(0,s.kt)("inlineCode",{parentName:"p"},".env.local")," file and enter the following values:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"STYTCH_PROJECT_ENV=test\nSTYTCH_PROJECT_ID=GET_FROM_STYTCH_DASHBOARD\nSTYTCH_PUBLIC_TOKEN=GET_FROM_STYTCH_DASHBOARD\nSTYTCH_SECRET=GET_FROM_STYTCH_DASHBOARD\nNEXT_PUBLIC_SUPABASE_URL=GET_FROM_SUPABASE_DASHBOARD\nNEXT_PUBLIC_SUPABASE_KEY=GET_FROM_SUPABASE_DASHBOARD\nSUPABASE_SIGNING_SECRET=GET_FROM_SUPABASE_DASHBOARD\n")),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: Stytch values can be found in the project ",(0,s.kt)("a",{parentName:"p",href:"https://stytch.com/dashboard/api-keys?utm_source=supabase&utm_medium=guide"},"dashboard")," under ",(0,s.kt)("strong",{parentName:"p"},"API Keys"),".")),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Stytch API keys",src:n(72801).Z,width:"1999",height:"862"})),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: Supabase values can be found under ",(0,s.kt)("strong",{parentName:"p"},"Settings")," > ",(0,s.kt)("strong",{parentName:"p"},"API")," for your project.")),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Supabase API keys",src:n(5575).Z,width:"1999",height:"1078"})),(0,s.kt)("p",null,"Start your Next.js development server to read in the new values from ",(0,s.kt)("inlineCode",{parentName:"p"},".env.local"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,s.kt)("p",null,"You should have a running Next.js application on ",(0,s.kt)("inlineCode",{parentName:"p"},"localhost:3000"),"."),(0,s.kt)("h2",{id:"step-5-build-the-login-form"},"Step 5: Build the Login Form"),(0,s.kt)("p",null,"Now we will replace the default Next.js home page with a login UI. We will use the Stytch React library."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: Stytch provides direct API access for those that want to build login UI themselves")),(0,s.kt)("p",null,"Install the ",(0,s.kt)("inlineCode",{parentName:"p"},"@stytch/stytch-react")," library."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @stytch/stytch-react\n")),(0,s.kt)("p",null,"In the root directory, create a new folder named ",(0,s.kt)("inlineCode",{parentName:"p"},"components")," and file in that folder named ",(0,s.kt)("inlineCode",{parentName:"p"},"/StytchLogin.js"),". Within this file, paste the snippet below. This will configure, and style the Stytch React component to use Email magic links."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// components/StytchLogin.js\nimport React from 'react'\nimport { Stytch } from '@stytch/stytch-react'\n\nconst stytchConfig = {\n  loginOrSignupView: {\n    products: ['emailMagicLinks'],\n    emailMagicLinksOptions: {\n      loginRedirectURL: 'http://localhost:3000/api/authenticate',\n      loginExpirationMinutes: 30,\n      signupRedirectURL: 'http://localhost:3000/api/authenticate',\n      signupExpirationMinutes: 30,\n      createUserAsPending: true,\n    },\n  },\n  style: {\n    fontFamily: '\"Helvetica New\", Helvetica, sans-serif',\n    width: '321px',\n    primaryColor: '#0577CA',\n  },\n}\n\nconst StytchLogin = ({ publicToken }) => {\n  return (\n    <Stytch\n      publicToken={publicToken}\n      loginOrSignupView={stytchConfig.loginOrSignupView}\n      style={stytchConfig.style}\n    />\n  )\n}\n\nexport default StytchLogin\n")),(0,s.kt)("p",null,"Additionally, create a profile component by creating a file called ",(0,s.kt)("inlineCode",{parentName:"p"},"Profile.js")," in ",(0,s.kt)("inlineCode",{parentName:"p"},"/components"),". We will use this component to render our expenses stored in Supabase later on."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// components/Profile.js\nimport React from 'react'\nimport Link from 'next/link'\n\nexport default function Profile({ user }) {\n  return (\n    <div>\n      <h1>Welcome {user.userId}</h1>\n      <h2>Your expenses</h2>\n      {user.expenses?.length > 0 ? (\n        user.expenses.map((expense) => (\n          <p key={expense.id}>\n            {expense.title}: ${expense.value}\n          </p>\n        ))\n      ) : (\n        <p>You have no expenses!</p>\n      )}\n\n      <Link href=\"/api/logout\" passHref>\n        <button>\n          <a>Logout</a>\n        </button>\n      </Link>\n    </div>\n  )\n}\n")),(0,s.kt)("p",null,"Finally, replace the contents of the file ",(0,s.kt)("inlineCode",{parentName:"p"},"/pages/index.js")," to render our new ",(0,s.kt)("inlineCode",{parentName:"p"},"StytchLogin")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"Profile")," components."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// pages/index.js\nimport styles from '../styles/Home.module.css'\nimport Profile from '../components/Profile'\nimport StytchLogin from '../components/StytchLogin'\n\nconst Index = ({ user, publicToken }) => {\n  let content\n  if (user) {\n    content = <Profile user={user} />\n  } else {\n    content = <StytchLogin publicToken={publicToken} />\n  }\n\n  return <div className={styles.main}>{content}</div>\n}\n\nexport async function getServerSideProps({ req, res }) {\n  const user = null // Will update later\n  return {\n    props: { user, publicToken: process.env.STYTCH_PUBLIC_TOKEN },\n  }\n}\n\nexport default Index\n")),(0,s.kt)("p",null,"On ",(0,s.kt)("inlineCode",{parentName:"p"},"localhost:3000")," there is now a login form prompting for your email address."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Email login step one",src:n(31219).Z,width:"840",height:"644"})),(0,s.kt)("p",null,"Enter your email address and press ",(0,s.kt)("strong",{parentName:"p"},"Continue with email"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Email login step two",src:n(45338).Z,width:"798",height:"654"})),(0,s.kt)("p",null,"In your inbox you will find a login request from your app."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Email login step three",src:n(95483).Z,width:"1278",height:"902"})),(0,s.kt)("p",null,"However, if you click the link in the email you will get a 404. We need to build an API route to handle the email magic link authentication."),(0,s.kt)("h2",{id:"step-6-authenticate-and-start-a-session"},"Step 6: Authenticate and start a session"),(0,s.kt)("p",null,"To make authentication easier we will use the Stytch Node.js library. Run"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm install stytch\n")),(0,s.kt)("p",null,"Additionally, we will need to store the authenticated session in a cookie. Run"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm install cookies-next\n")),(0,s.kt)("p",null,"Create a new folder named ",(0,s.kt)("inlineCode",{parentName:"p"},"utils")," and inside a file named",(0,s.kt)("inlineCode",{parentName:"p"},"stytchLogic.js")," with the following contents"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// utils/stytchLogic.js\nimport * as stytch from 'stytch'\nimport { getCookie, setCookies, removeCookies } from 'cookies-next'\n\nexport const SESSION_COOKIE = 'stytch_cookie'\n\nlet client\nconst loadStytch = () => {\n  if (!client) {\n    client = new stytch.Client({\n      project_id: process.env.STYTCH_PROJECT_ID,\n      secret: process.env.STYTCH_SECRET,\n      env:\n        process.env.STYTCH_PROJECT_ENV === 'live'\n          ? stytch.envs.live\n          : stytch.envs.test,\n    })\n  }\n\n  return client\n}\n\nexport const getAuthenticatedUserFromSession = async (req, res) => {\n  const sessionToken = getCookie(SESSION_COOKIE, { req, res })\n  if (!sessionToken) {\n    return null\n  }\n\n  try {\n    const stytchClient = loadStytch()\n    const resp = await stytchClient.sessions.authenticate({\n      session_token: sessionToken,\n    })\n    return resp.session.user_id\n  } catch (error) {\n    console.log(error)\n    return null\n  }\n}\n\nexport const revokeAndClearSession = async (req, res) => {\n  const sessionToken = getCookie(SESSION_COOKIE, { req, res })\n\n  if (sessionToken) {\n    try {\n      const stytchClient = loadStytch()\n      await stytchClient.sessions.revoke({\n        session_token: sessionToken,\n      })\n    } catch (error) {\n      console.log(error)\n    }\n    removeCookies(SESSION_COOKIE, { req, res })\n  }\n\n  return res.redirect('/')\n}\n\nexport const authenticateTokenStartSession = async (req, res) => {\n  const { token, type } = req.query\n  let sessionToken\n  try {\n    const stytchClient = loadStytch()\n    const resp = await stytchClient.magicLinks.authenticate(token, {\n      session_duration_minutes: 30,\n    })\n    sessionToken = resp.session_token\n  } catch (error) {\n    console.log(error)\n    const errorString = JSON.stringify(error)\n    return res.status(400).json({ errorString })\n  }\n\n  setCookies(SESSION_COOKIE, sessionToken, {\n    req,\n    res,\n    maxAge: 60 * 60 * 24,\n    secure: true,\n  })\n\n  return res.redirect('/')\n}\n")),(0,s.kt)("p",null,"This logic is responsible for setting up the Stytch client we will use to call the API. It provides functions we will use to login, logout, and validate user sessions."),(0,s.kt)("p",null,"In order to complete the email login flow, create a new file ",(0,s.kt)("inlineCode",{parentName:"p"},"pages/api/authenticate.js")," with the contents:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// pages/api/authenticate.js\nimport { authenticateTokenStartSession } from '../../utils/stytchLogic'\n\nexport default async function handler(req, res) {\n  return authenticateTokenStartSession(req, res)\n}\n")),(0,s.kt)("p",null,"We will also create a logout API endpoint with similar contents. In ",(0,s.kt)("inlineCode",{parentName:"p"},"pages/api/logout.js")," include the following:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// pages/api/logout.js\nimport { revokeAndClearSession } from '../../utils/stytchLogic'\n\nexport default async function handler(req, res) {\n  return revokeAndClearSession(req, res)\n}\n")),(0,s.kt)("p",null,"Finally, update ",(0,s.kt)("inlineCode",{parentName:"p"},"pages/index.js")," by importing ",(0,s.kt)("inlineCode",{parentName:"p"},"getAuthenticatedUserFromSession"),", and calling it to set the user variable in ",(0,s.kt)("inlineCode",{parentName:"p"},"getServerSideProps"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// pages/index.js\nimport styles from '../styles/Home.module.css'\n\nimport StytchLogin from '../components/StytchLogin'\nimport Profile from '../components/Profile'\nimport { getAuthenticatedUserFromSession } from '../utils/stytchLogic'\n\nconst Index = ({ user, publicToken }) => {\n  let content\n  if (user) {\n    content = <Profile user={user} />\n  } else {\n    content = <StytchLogin publicToken={publicToken} />\n  }\n\n  return <div className={styles.main}>{content}</div>\n}\n\nexport async function getServerSideProps({ req, res }) {\n  const userId = await getAuthenticatedUserFromSession(req, res)\n  if (userId) {\n    return {\n      props: { user: { userId }, publicToken: process.env.STYTCH_PUBLIC_TOKEN },\n    }\n  }\n  return {\n    props: { publicToken: process.env.STYTCH_PUBLIC_TOKEN },\n  }\n}\n\nexport default Index\n")),(0,s.kt)("p",null,"Return to ",(0,s.kt)("inlineCode",{parentName:"p"},"localhost:3000"),", and login again by sending yourself a new email. Upon clicking through in the email you should be presented with \u201cWelcome $USER_ID\u201d. If you refresh the page, you should remain in an authenticated state. If you press ",(0,s.kt)("strong",{parentName:"p"},"Logout")," then you should return to the login screen."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Profile page",src:n(23124).Z,width:"1999",height:"517"})),(0,s.kt)("p",null,"Now that we have a working login flow with persistent authentication it is time to pull in our expense data from Supabase."),(0,s.kt)("h2",{id:"step-7-requesting-user-data-from-supabase"},"Step 7: Requesting user data from Supabase"),(0,s.kt)("p",null,"First, install the Supabase client:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @supabase/supabase-js\n")),(0,s.kt)("p",null,"In order to pass an authenticated ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," to Supabase we will package it within a JWT. Install jsonwebtoken:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm install jsonwebtoken\n")),(0,s.kt)("p",null,"Create a new file ",(0,s.kt)("inlineCode",{parentName:"p"},"utils/supabase.js")," and add the following:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// utils/supabase.js\nimport { createClient } from '@supabase/supabase-js'\nimport jwt from 'jsonwebtoken'\n\nconst getSupabase = (userId) => {\n  const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL,\n    process.env.NEXT_PUBLIC_SUPABASE_KEY\n  )\n\n  if (userId) {\n    const payload = {\n      userId,\n      exp: Math.floor(Date.now() / 1000) + 60 * 60,\n    }\n\n    supabase.auth.session = () => ({\n      access_token: jwt.sign(payload, process.env.SUPABASE_SIGNING_SECRET),\n    })\n  }\n\n  return supabase\n}\n\nexport { getSupabase }\n")),(0,s.kt)("p",null,"Our payload for the JWT will contain our user's unique identifier from Stytch, their ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id"),". We are signing this JWT using Supabase's signing secret, so Supabase will be able to validate it is authentic and hasn't been tampered with in transit."),(0,s.kt)("p",null,"Let's load our expenses from Supabase on the home page! Update ",(0,s.kt)("inlineCode",{parentName:"p"},"pages/index.js")," a final time to make a request for expense data from Supabase."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"import styles from '../styles/Home.module.css'\n\nimport StytchLogin from '../components/StytchLogin'\nimport Profile from '../components/Profile'\nimport { getAuthenticatedUserFromSession } from '../utils/stytchLogic'\nimport { getSupabase } from '../utils/supabase'\n\nconst Index = ({ user, publicToken }) => {\n  let content\n  if (user) {\n    content = <Profile user={user} />\n  } else {\n    content = <StytchLogin publicToken={publicToken} />\n  }\n\n  return <div className={styles.main}>{content}</div>\n}\n\nexport async function getServerSideProps({ req, res }) {\n  const userId = await getAuthenticatedUserFromSession(req, res)\n\n  if (userId) {\n    const supabase = getSupabase(userId)\n    const { data: expenses } = await supabase.from('expenses').select('*')\n\n    return {\n      props: {\n        user: { userId, expenses },\n        publicToken: process.env.STYTCH_PUBLIC_TOKEN,\n      },\n    }\n  } else {\n    return {\n      props: { publicToken: process.env.STYTCH_PUBLIC_TOKEN },\n    }\n  }\n}\n\nexport default Index\n")),(0,s.kt)("p",null,"When we reload our application, we are still getting the empty state for expenses."),(0,s.kt)("p",null,"This is because we enabled Row Level Security, which blocks all requests by default and lets you granularly control access to the data in your database. To enable our user to select their expenses we need to write a RLS policy."),(0,s.kt)("h2",{id:"step-8-write-a-policy-to-allow-select"},"Step 8: Write a policy to allow select"),(0,s.kt)("p",null,"Our policy will need to know who our currently logged in user is to determine whether or not they should have access. Let's create a PostgreSQL function to extract the current user from our new JWT."),(0,s.kt)("p",null,"Navigate back to the Supabase dashboard, select SQL from the sidebar menu, and click ",(0,s.kt)("strong",{parentName:"p"},"New query"),". This will create a new query,, which will allow us to run any SQL against our Postgres database."),(0,s.kt)("p",null,"Write the following and click ",(0,s.kt)("strong",{parentName:"p"},"Run"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},"create or replace function auth.user_id() returns text as $$\n select nullif(current_setting('request.jwt.claims', true)::json->>'userId', '')::text;\n$$ language sql stable;\n")),(0,s.kt)("p",null,"You should see the output ",(0,s.kt)("inlineCode",{parentName:"p"},"Success, no rows returned"),". This created a function called ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.user_id()"),", which will inspect the ",(0,s.kt)("inlineCode",{parentName:"p"},"userId")," field of our JWT payload."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: To learn more about PostgreSQL functions, check out this ",(0,s.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=MJZCCpCYEqk"},"deep dive video"),".")),(0,s.kt)("p",null,"Let's create a policy that checks whether this user is the owner of an expense."),(0,s.kt)("p",null,"Select ",(0,s.kt)("strong",{parentName:"p"},"Authentication")," from the Supabase sidebar menu, click ",(0,s.kt)("strong",{parentName:"p"},"Policies"),", then ",(0,s.kt)("strong",{parentName:"p"},"New Policy"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Supabase authentication page",src:n(2505).Z,width:"1999",height:"484"})),(0,s.kt)("p",null,"From the modal, select ",(0,s.kt)("strong",{parentName:"p"},"For full customization create a policy from scratch")," and add the following."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Supabase create policy page",src:n(42195).Z,width:"1999",height:"1163"})),(0,s.kt)("p",null,"This policy is calling the function we just created to get the currently logged in user's ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.user_id()")," and checking whether this matches the ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," column for the current expense. If it does, then it will allow the user to select it, otherwise it will continue to deny."),(0,s.kt)("p",null,"Click Review and then Save policy. After you've saved, click Enable RLS on the table to enable the policy we just created."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: To learn more about RLS and policies, check out this ",(0,s.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=Ow_Uzedfohk"},"video"),".")),(0,s.kt)("p",null,"The last thing we need to do is update the ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," columns for our existing expenses."),(0,s.kt)("p",null,"Head back to the Supabase dashboard, and select Table editor from the sidebar. You will notice each entry has ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," set to ",(0,s.kt)("inlineCode",{parentName:"p"},"NULL"),". We need to update this value to the proper ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Supabase null users in table",src:n(17062).Z,width:"1926",height:"510"})),(0,s.kt)("p",null,"To get the ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," for our Stytch user, you can pull it from the welcome page in our example app (eg ",(0,s.kt)("inlineCode",{parentName:"p"},"user-test-61497d40-f957-45cd-a6c8-5408d22e93bc"),")."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Get user_id",src:n(92554).Z,width:"1999",height:"390"})),(0,s.kt)("p",null,"Update each row in Supabase to this ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Populate user_id",src:n(98660).Z,width:"1934",height:"518"})),(0,s.kt)("p",null,"Return to ",(0,s.kt)("inlineCode",{parentName:"p"},"localhost:3000"),", and you will see your expenses listed."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Listed expenses",src:n(15056).Z,width:"1999",height:"637"})),(0,s.kt)("p",null,"We now have a basic expense tracker application powered by Stytch, Supabase, and Next.js. From here you could add additional features like adding, editing, and organizing your expenses further."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Note: You can find a completed version of this project on ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/stytchauth/stytch-nextjs-supabase"},"Github"),".")),(0,s.kt)("h2",{id:"optional-add-google-one-tap"},"Optional: Add Google One Tap"),(0,s.kt)("p",null,"In this optional step, we will extend our application to allow users to login with Google One Tap in addition to Email magic links."),(0,s.kt)("p",null,"You will need to follow the first four steps of ",(0,s.kt)("a",{parentName:"p",href:"https://stytch.com/docs/one-tap-guide?utm_source=supabase&utm_medium=guide"},"this guide")," to create a Google project, set up Google OAuth consent, and configure credentials and redirect URLs."),(0,s.kt)("p",null,"First, we will make some adjustments to the ",(0,s.kt)("inlineCode",{parentName:"p"},"StytchLogin")," component. We will update the configuration, so that it uses both Google OAuth, and Email magic links."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// components/StytchLogin.js\nimport React from 'react'\nimport { Stytch } from '@stytch/stytch-react'\n\nconst stytchConfig = {\n  loginOrSignupView: {\n    products: ['oauth', 'emailMagicLinks'],\n    oauthOptions: {\n      providers: [\n        {\n          type: 'google',\n          one_tap: true,\n          position: 'embedded',\n        },\n      ],\n      loginRedirectURL: 'http://localhost:3000/api/authenticate?type=oauth',\n      signupRedirectURL: 'http://localhost:3000/api/authenticate?type=oauth',\n    },\n    emailMagicLinksOptions: {\n      loginRedirectURL: 'http://localhost:3000/api/authenticate',\n      loginExpirationMinutes: 30,\n      signupRedirectURL: 'http://localhost:3000/api/authenticate',\n      signupExpirationMinutes: 30,\n      createUserAsPending: true,\n    },\n  },\n  style: {\n    fontFamily: '\"Helvetica New\", Helvetica, sans-serif',\n    width: '321px',\n    primaryColor: '#0577CA',\n  },\n}\n\nconst StytchLogin = ({ publicToken }) => {\n  return (\n    <Stytch\n      publicToken={publicToken}\n      loginOrSignupView={stytchConfig.loginOrSignupView}\n      style={stytchConfig.style}\n    />\n  )\n}\n\nexport default StytchLogin\n")),(0,s.kt)("p",null,"We also need to make an adjustment to the function ",(0,s.kt)("inlineCode",{parentName:"p"},"authenticateTokenStartSession")," in ",(0,s.kt)("inlineCode",{parentName:"p"},"stytchLogic.js"),". Stytch has separate authentication endpoints for Email magic links and OAuth, so we need to route our token correctly."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-jsx"},"// utils/stytchLogic.js\n\n// leave the rest of the file contents as is\nexport const authenticateTokenStartSession = async (req, res) => {\n  const { token, type } = req.query\n  let sessionToken\n  try {\n    const stytchClient = loadStytch()\n    if (type == 'oauth') {\n      const resp = await stytchClient.oauth.authenticate(token, {\n        session_duration_minutes: 30,\n        session_management_type: 'stytch',\n      })\n      sessionToken = resp.session.stytch_session.session_token\n    } else {\n      const resp = await stytchClient.magicLinks.authenticate(token, {\n        session_duration_minutes: 30,\n      })\n      sessionToken = resp.session_token\n    }\n  } catch (error) {\n    console.log(error)\n    const errorString = JSON.stringify(error)\n    return res.status(400).json({ errorString })\n  }\n\n  setCookies(SESSION_COOKIE, sessionToken, {\n    req,\n    res,\n    maxAge: 60 * 60 * 24,\n    secure: true,\n  })\n\n  return res.redirect('/')\n}\n")),(0,s.kt)("p",null,"With these two changes you will now have a working Google One Tap authentication method along with email magic links."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Google One Tap",src:n(43165).Z,width:"966",height:"952"})),(0,s.kt)("h2",{id:"resources"},"Resources"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://stytch.com/blog?utm_source=supabase&utm_medium=guide"},"Stytch blog")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://stytch.com/docs?utm_source=supabase&utm_medium=guide"},"Stytch documentation"))))}u.isMDXComponent=!0},31127:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/01-0c5880b09541fe8dc7e3bf9c56e9a13a.png"},88931:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/02-fb654af23f7feead28dda2d65141602d.png"},68711:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/03-dc273fa9d474c10ba1f8f6b1650644e7.png"},831:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/04-d5413db67f7fb4aadb81fd5888cbb157.png"},9197:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/05-fbae116150703410ce80d70344b1a76f.png"},45831:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/06-1cf18c70ffd688b8cd8047b5aff6296d.png"},2859:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/07-2a1168c1d99b8938128ac64e7c429ada.png"},72801:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/08-d3984111063c401c264c46161dc48aa6.png"},5575:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/09-275aedc51bbad8818a8ea95666746c8a.png"},31219:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/10-f453a81f7589160b756ad0adf874980b.png"},45338:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/11-bc93cb885cca1907b020e51c50595490.png"},95483:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/12-422c0bd2ab0c16ae753ac96e65bd3bd1.png"},23124:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/13-a57ac3701894c41e3c22b150a0b21981.png"},2505:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/14-7ad076e4a9fd03acbce6ba4941ae28b2.png"},42195:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/15-787b0c4e7cbd8c530335bad8b7f01e0f.png"},17062:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/16-27e5e8d344133e2328cc80e3285b82bf.png"},92554:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/17-cf5f29dc9cdda13af78254ba6e231a77.png"},98660:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/18-c495961404b856baf1b6866e0571d001.png"},15056:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/19-65b0c69a5e6471bacc53a980a0c81f6c.png"},43165:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/20-31adebceef10496e6aa0a77559e79c63.png"}}]);