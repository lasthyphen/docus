"use strict";(self.webpackChunkreference_docs=self.webpackChunkreference_docs||[]).push([[91166],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(67294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,p=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=l(n),h=s,m=c["".concat(p,".").concat(h)]||c[h]||d[h]||r;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,i=new Array(r);i[0]=h;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[c]="string"==typeof e?e:s,i[1]=o;for(var l=2;l<r;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},27590:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>l});var a=n(87462),s=(n(67294),n(3905));const r={id:"supertokens",title:"SuperTokens",description:"Create a Next.js application secured by SuperTokens and PostgreSQL Row Level Security."},i=void 0,o={unversionedId:"guides/integrations/supertokens",id:"guides/integrations/supertokens",title:"SuperTokens",description:"Create a Next.js application secured by SuperTokens and PostgreSQL Row Level Security.",source:"@site/docs/guides/integrations/supertokens.mdx",sourceDirName:"guides/integrations",slug:"/guides/integrations/supertokens",permalink:"/docs/guides/integrations/supertokens",draft:!1,editUrl:"https://github.com/docs/guides/integrations/supertokens.mdx",tags:[],version:"current",frontMatter:{id:"supertokens",title:"SuperTokens",description:"Create a Next.js application secured by SuperTokens and PostgreSQL Row Level Security."}},p={},l=[{value:"Demo App",id:"demo-app",level:3},{value:"Step 1: Create a new Supabase project",id:"step-1-create-a-new-supabase-project",level:2},{value:"Step 2: Creating tables in Supabase",id:"step-2-creating-tables-in-supabase",level:2},{value:"Step 3: Setup your Next.js App with SuperTokens.",id:"step-3-setup-your-nextjs-app-with-supertokens",level:2},{value:"Step 4: Creating a Supabase JWT to access Supabase",id:"step-4-creating-a-supabase-jwt-to-access-supabase",level:2},{value:"Step 5: Creating a Supabase client",id:"step-5-creating-a-supabase-client",level:2},{value:"Step 6: Inserting users into Supabase when they sign up:",id:"step-6-inserting-users-into-supabase-when-they-sign-up",level:2},{value:"Step 7: Retrieving the user&#39;s email on the frontend",id:"step-7-retrieving-the-users-email-on-the-frontend",level:2},{value:"Step 8: Create Policies to enforce Row Level Security for Select and Insert requests",id:"step-8-create-policies-to-enforce-row-level-security-for-select-and-insert-requests",level:2},{value:"SELECT query policy",id:"select-query-policy",level:3},{value:"INSERT query policy",id:"insert-query-policy",level:3},{value:"Step 9: Test your changes",id:"step-9-test-your-changes",level:2},{value:"Resources",id:"resources",level:2}],u={toc:l};function c(e){let{components:t,...r}=e;return(0,s.kt)("wrapper",(0,a.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.supertokens.com"},"SuperTokens")," is an open source authentication solution which provides many stratergies for authenticating and managing users. You can use the managed service for easy setup or you can self host the solution to have complete control over your data."),(0,s.kt)("p",null,"In this guide we will build a simple web application using SuperTokens, Supabase, and Next.js. You will be able to sign up using SuperTokens and your email and user ID will be stored in Supabase. Once authenticated the frontend will be able to query Supabase and retrieve the user's email. Our example app will be using the ",(0,s.kt)("a",{parentName:"p",href:"https://supertokens.com/docs/thirdpartyemailpassword/introduction"},"Email-Password and Social Login")," recipe for authentication and session management."),(0,s.kt)("p",null,"We will use Supabase to store and authorize access to user data. Supabase makes it simple to setup Row Level Security(RLS) policies which ensure users can only read and write data that belongs to them."),(0,s.kt)("h3",{id:"demo-app"},"Demo App"),(0,s.kt)("p",null,"You can find a demo app using SuperTokens, Supabase and Nexts.js on ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/supertokens/supertokens-auth-react/tree/master/examples/with-supabase"},"Github")),(0,s.kt)("h2",{id:"step-1-create-a-new-supabase-project"},"Step 1: Create a new Supabase project"),(0,s.kt)("p",null,"From your ",(0,s.kt)("a",{parentName:"p",href:"https://app.supabase.com/"},"Supabase dashboard"),", click ",(0,s.kt)("inlineCode",{parentName:"p"},"New project"),"."),(0,s.kt)("p",null,"Enter a ",(0,s.kt)("inlineCode",{parentName:"p"},"Name")," for your Supabase project."),(0,s.kt)("p",null,"Enter a secure ",(0,s.kt)("inlineCode",{parentName:"p"},"Database Password"),"."),(0,s.kt)("p",null,"Select the same ",(0,s.kt)("inlineCode",{parentName:"p"},"Region")," you host your app's backend in."),(0,s.kt)("p",null,"Click ",(0,s.kt)("inlineCode",{parentName:"p"},"Create new project"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"New Supabase project settings",src:n(75696).Z,width:"1340",height:"874"})),(0,s.kt)("h2",{id:"step-2-creating-tables-in-supabase"},"Step 2: Creating tables in Supabase"),(0,s.kt)("p",null,"From the sidebar menu in the ",(0,s.kt)("a",{parentName:"p",href:"https://app.supabase.com/"},"Supabase dashboard"),", click ",(0,s.kt)("inlineCode",{parentName:"p"},"Table editor"),", then ",(0,s.kt)("inlineCode",{parentName:"p"},"New table"),"."),(0,s.kt)("p",null,"Enter ",(0,s.kt)("inlineCode",{parentName:"p"},"users")," as the ",(0,s.kt)("inlineCode",{parentName:"p"},"Name")," field."),(0,s.kt)("p",null,"Select ",(0,s.kt)("inlineCode",{parentName:"p"},"Enable Row Level Security (RLS)"),"."),(0,s.kt)("p",null,"Remove the default columns"),(0,s.kt)("p",null,"Create two new columns:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"user_id")," as ",(0,s.kt)("inlineCode",{parentName:"li"},"varchar")," as primary key"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"email")," as ",(0,s.kt)("inlineCode",{parentName:"li"},"varchar"))),(0,s.kt)("p",null,"Click ",(0,s.kt)("inlineCode",{parentName:"p"},"Save")," to create the new table."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Users table",src:n(49145).Z,width:"1676",height:"2030"})),(0,s.kt)("h2",{id:"step-3-setup-your-nextjs-app-with-supertokens"},"Step 3: Setup your Next.js App with SuperTokens."),(0,s.kt)("p",null,"Since the scope of this guide is limited to the intergration between SuperTokens and Supabase, you can refer to the SuperTokens website to see ",(0,s.kt)("a",{parentName:"p",href:"https://supertokens.com/docs/thirdpartyemailpassword/nextjs/about"},"how to setup your Next.js app with SuperTokens"),"."),(0,s.kt)("p",null,"Once you finish setting up your app, you will be greeted with the following screen"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"SuperTokens Auth Screen",src:n(68198).Z,width:"3450",height:"2034"})),(0,s.kt)("h2",{id:"step-4-creating-a-supabase-jwt-to-access-supabase"},"Step 4: Creating a Supabase JWT to access Supabase"),(0,s.kt)("p",null,"In our Nextjs app when a user signs up, we want to store the user's email in Supabase. We would then retrieve this email from Supabase and display it on our frontend."),(0,s.kt)("p",null,"To use the Supabase client to query the database we will need to create a JWT signed with your Supabase app's signing secret. This JWT will also need to contain the user's userId so Supabase knows an authenticated user is making the request."),(0,s.kt)("p",null,"To create this flow we will need to modify SuperTokens so that, when a user signs up or signs in, a JWT signed with Supabase's signing secret is created and attached to the user's session. Attaching the JWT to the user's session will allow us to retrieve the Supabase JWT on the frontend and backend (post session verification), using which we can query Supabase."),(0,s.kt)("p",null,"We want to create a Supabase JWT when we are creating a SuperTokens' session. This can be done by overriding the ",(0,s.kt)("inlineCode",{parentName:"p"},"createNewSession")," function in your backend config."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},'// config/backendConfig.ts\n\nimport ThirdPartyEmailPasswordNode from "supertokens-node/recipe/thirdpartyemailpassword";\nimport SessionNode from "supertokens-node/recipe/session";\nimport { TypeInput } from "supertokens-node/lib/build/types";\nimport { appInfo } from "./appInfo";\nimport jwt from "jsonwebtoken";\n\nlet backendConfig = (): TypeInput => {\n    return {\n        framework: "express",\n        supertokens: {\n            connectionURI: "https://try.supertokens.com",\n        },\n        appInfo,\n        recipeList: [\n            ThirdPartyEmailPasswordNode.init({...}),\n            SessionNode.init({\n                override: {\n                    functions: (originalImplementation) => {\n                        return {\n                            ...originalImplementation,\n                            // We want to create a JWT which contains the users userId signed with Supabase\'s secret so\n                            // it can be used by Supabase to validate the user when retrieving user data from their service.\n                            // We store this token in the accessTokenPayload so it can be accessed on the frontend and on the backend.\n                            createNewSession: async function (input) {\n                                const payload = {\n                                    userId: input.userId,\n                                    exp: Math.floor(Date.now() / 1000) + 60 * 60,\n                                };\n\n                                const supabase_jwt_token = jwt.sign(payload, process.env.SUPABASE_SIGNING_SECRET);\n\n                                input.accessTokenPayload = {\n                                    ...input.accessTokenPayload,\n                                    supabase_token: supabase_jwt_token,\n                                };\n\n                                return await originalImplementation.createNewSession(input);\n                            },\n                        };\n                    },\n                },\n            }),\n        ],\n        isInServerlessEnv: true,\n    };\n};\n\n')),(0,s.kt)("p",null,"As seen above, we will be using the ",(0,s.kt)("inlineCode",{parentName:"p"},"jsonwebtoken")," library to create a JWT signed with Supabase's signing secret whose payload contains the user's userId."),(0,s.kt)("p",null,"We will be storing this token in the ",(0,s.kt)("inlineCode",{parentName:"p"},"accessTokenPayload")," which will essentially allow us to access the ",(0,s.kt)("inlineCode",{parentName:"p"},"supabase_token")," on the frontend and backend whilst the user is logged in."),(0,s.kt)("h2",{id:"step-5-creating-a-supabase-client"},"Step 5: Creating a Supabase client"),(0,s.kt)("p",null,"Create a new file called ",(0,s.kt)("inlineCode",{parentName:"p"},"utils/supabase.ts")," and add the following:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"// utils/supabase.ts\n\nimport { createClient } from '@supabase/supabase-js'\n\nconst getSupabase = (access_token) => {\n  const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL,\n    process.env.NEXT_PUBLIC_SUPABASE_KEY\n  )\n\n  supabase.auth.session = () => ({\n    access_token,\n  })\n\n  return supabase\n}\n\nexport { getSupabase }\n")),(0,s.kt)("p",null,"This will be our client for talking to Supabase. We can pass it an ",(0,s.kt)("inlineCode",{parentName:"p"},"access_token")," and it will be attached to our request. This ",(0,s.kt)("inlineCode",{parentName:"p"},"access_token")," is the same as the ",(0,s.kt)("inlineCode",{parentName:"p"},"supabase_token")," we had created earlier."),(0,s.kt)("h2",{id:"step-6-inserting-users-into-supabase-when-they-sign-up"},"Step 6: Inserting users into Supabase when they sign up:"),(0,s.kt)("p",null,"In our example app there are two ways for signing up a user. Email-Password and Social Login based authentication. We will need to override both these APIs such that when a user signs up, their email mapped to their userId is stored in Supabase."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},'// config/backendConfig.ts\n\nimport ThirdPartyEmailPasswordNode from "supertokens-node/recipe/thirdpartyemailpassword";\nimport SessionNode from "supertokens-node/recipe/session";\nimport { TypeInput } from "supertokens-node/lib/build/types";\nimport { appInfo } from "./appInfo";\nimport jwt from "jsonwebtoken";\nimport { getSupabase } from "../utils/supabase";\n\nlet backendConfig = (): TypeInput => {\n    return {\n        framework: "express",\n        supertokens: {\n            connectionURI: "https://try.supertokens.com",\n        },\n        appInfo,\n        recipeList: [\n            ThirdPartyEmailPasswordNode.init({\n                providers: [...],\n                override: {\n                    apis: (originalImplementation) => {\n                        return {\n                            ...originalImplementation,\n                            // the thirdPartySignInUpPost function handles sign up/in via Social login\n                            thirdPartySignInUpPOST: async function (input) {\n                                if (originalImplementation.thirdPartySignInUpPOST === undefined) {\n                                    throw Error("Should never come here");\n                                }\n\n                                // call the sign up/in api for social login\n                                let response = await originalImplementation.thirdPartySignInUpPOST(input);\n\n                                // check that there is no issue with sign up and that a new user is created\n                                if (response.status === "OK" && response.createdNewUser) {\n\n                                    // retrieve the accessTokenPayload from the user\'s session\n                                    const accessTokenPayload = response.session.getAccessTokenPayload();\n\n                                    // create a supabase client with the supabase_token from the accessTokenPayload\n                                    const supabase = getSupabase(accessTokenPayload.supabase_token);\n\n                                    // store the user\'s email mapped to their userId in Supabase\n                                    const { error } = await supabase\n                                        .from("users")\n                                        .insert({ email: response.user.email, user_id: response.user.id });\n\n                                    if (error !== null) {\n\n                                        throw error;\n                                    }\n                                }\n\n                                return response;\n                            },\n                            // the emailPasswordSignUpPOST function handles sign up via Email-Password\n                            emailPasswordSignUpPOST: async function (input) {\n                                if (originalImplementation.emailPasswordSignUpPOST === undefined) {\n                                    throw Error("Should never come here");\n                                }\n\n                                let response = await originalImplementation.emailPasswordSignUpPOST(input);\n\n                                if (response.status === "OK") {\n\n                                    // retrieve the accessTokenPayload from the user\'s session\n                                    const accessTokenPayload = response.session.getAccessTokenPayload();\n\n                                    // create a supabase client with the supabase_token from the accessTokenPayload\n                                    const supabase = getSupabase(accessTokenPayload.supabase_token);\n\n                                    // store the user\'s email mapped to their userId in Supabase\n                                    const { error } = await supabase\n                                        .from("users")\n                                        .insert({ email: response.user.email, user_id: response.user.id });\n\n                                    if (error !== null) {\n\n                                        throw error;\n                                    }\n                                }\n\n                                return response;\n                            },\n                        };\n                    },\n                },\n            }),\n            SessionNode.init({...}),\n        ],\n        isInServerlessEnv: true,\n    };\n};\n\n')),(0,s.kt)("p",null,"As seen above, we will be overriding the ",(0,s.kt)("inlineCode",{parentName:"p"},"emailPasswordSignUpPOST")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"thirdPartySignInUpPOST")," APIs such that if a user signs up, we retrieve the Supabase JWT (which we created in the ",(0,s.kt)("inlineCode",{parentName:"p"},"createNewSession")," function) from the user's accessTokenPayload and send a request to Supabase to insert the email-userid mapping."),(0,s.kt)("h2",{id:"step-7-retrieving-the-users-email-on-the-frontend"},"Step 7: Retrieving the user's email on the frontend"),(0,s.kt)("p",null,"Now that our backend is setup we can modify our frontend to retrieve the user's email from Supabase."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-tsx"},"// pages/index.tsx\n\nimport React, { useState, useEffect } from 'react'\nimport Head from 'next/head'\nimport styles from '../styles/Home.module.css'\nimport ThirdPartyEmailPassword, {\n  ThirdPartyEmailPasswordAuth,\n} from 'supertokens-auth-react/recipe/thirdpartyemailpassword'\nimport dynamic from 'next/dynamic'\nimport { useSessionContext } from 'supertokens-auth-react/recipe/session'\nimport { getSupabase } from '../utils/supabase'\n\nexport default function Home() {\n  return (\n    // We will wrap the ProtectedPage component with ThirdPartyEmailPasswordAuth so only an\n    // authenticated user can access it. This will also allow us to access the users session information\n    // within the component.\n    <ThirdPartyEmailPasswordAuth>\n      <ProtectedPage />\n    </ThirdPartyEmailPasswordAuth>\n  )\n}\n\nfunction ProtectedPage() {\n  // retrieve the authenticated user's accessTokenPayload and userId from the sessionContext\n  const { accessTokenPayload, userId } = useSessionContext()\n\n  if (sessionContext.loading === true) {\n    return null\n  }\n\n  const [userEmail, setEmail] = useState('')\n  useEffect(() => {\n    async function getUserEmail() {\n      // retrieve the supabase client who's JWT contains users userId, this will be\n      // used by supabase to check that the user can only access table entries which contain their own userId\n      const supabase = getSupabase(accessTokenPayload.supabase_token)\n\n      // retrieve the user's name from the users table whose email matches the email in the JWT\n      const { data } = await supabase\n        .from('users')\n        .select('email')\n        .eq('user_id', userId)\n\n      if (data.length > 0) {\n        setEmail(data[0].email)\n      }\n    }\n    getUserEmail()\n  }, [])\n\n  return (\n    <div className={styles.container}>\n      <Head>\n        <title>SuperTokens \ud83d\udcab</title>\n        <link rel=\"icon\" href=\"/favicon.ico\" />\n      </Head>\n\n      <main className={styles.main}>\n        <p className={styles.description}>\n          You are authenticated with SuperTokens! (UserId: {userId})\n          <br />\n          Your email retrieved from Supabase: {userEmail}\n        </p>\n      </main>\n    </div>\n  )\n}\n")),(0,s.kt)("p",null,"As seen above we will be using SuperTokens ",(0,s.kt)("inlineCode",{parentName:"p"},"useSessionContext")," hook to retrieve the authenticated user's ",(0,s.kt)("inlineCode",{parentName:"p"},"userId")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"accessTokenPayload"),". Using React's ",(0,s.kt)("inlineCode",{parentName:"p"},"useEffect")," hook we can use the Supabase client to retrieve the user's email from Supabase using the JWT retrieved from the user's ",(0,s.kt)("inlineCode",{parentName:"p"},"accessTokenPayload")," and their ",(0,s.kt)("inlineCode",{parentName:"p"},"userId"),"."),(0,s.kt)("h2",{id:"step-8-create-policies-to-enforce-row-level-security-for-select-and-insert-requests"},"Step 8: Create Policies to enforce Row Level Security for Select and Insert requests"),(0,s.kt)("p",null,"To enforce Row Level Security for the ",(0,s.kt)("inlineCode",{parentName:"p"},"Users")," table we will need to create policies for Select and Insert requests."),(0,s.kt)("p",null,"These polices will retrieve the userId from the JWT and check if it matches the userId in the Supabase table"),(0,s.kt)("p",null,"To do this we will need a PostgreSQL function to extract the userId from the JWT."),(0,s.kt)("p",null,"The payload in the JWT will have the following structure:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"// JWT payload\n{\n    userId,\n    exp\n}\n")),(0,s.kt)("p",null,"To create the PostgreSQL function, lets navigate back to the Supabase dashboard, select ",(0,s.kt)("inlineCode",{parentName:"p"},"SQL")," from the sidebar menu, and click ",(0,s.kt)("inlineCode",{parentName:"p"},"New query"),". This will create a new query called ",(0,s.kt)("inlineCode",{parentName:"p"},"new sql snippet"),", which will allow us to run any SQL against our Postgres database."),(0,s.kt)("p",null,"Write the following and click ",(0,s.kt)("inlineCode",{parentName:"p"},"Run"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},"create or replace function auth.user_id() returns text as $$\n  select nullif(current_setting('request.jwt.claims', true)::json->>'userId', '')::text;\n$$ language sql stable;\n")),(0,s.kt)("p",null,"This will create a function called ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.user_id()"),", which will inspect the ",(0,s.kt)("inlineCode",{parentName:"p"},"userId")," field of our JWT payload."),(0,s.kt)("h3",{id:"select-query-policy"},"SELECT query policy"),(0,s.kt)("p",null,"Our first policy will check whether the user is the owner of the email."),(0,s.kt)("p",null,"Select ",(0,s.kt)("inlineCode",{parentName:"p"},"Authentication")," from the Supabase sidebar menu, click ",(0,s.kt)("inlineCode",{parentName:"p"},"Policies"),", and then ",(0,s.kt)("inlineCode",{parentName:"p"},"New Policy")," on the ",(0,s.kt)("inlineCode",{parentName:"p"},"Users")," table."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Create new policy",src:n(9330).Z,width:"3454",height:"2034"})),(0,s.kt)("p",null,"From the modal, select ",(0,s.kt)("inlineCode",{parentName:"p"},"Create a policy from scratch")," and add the following."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Policy settings for SELECT",src:n(63473).Z,width:"2876",height:"1774"})),(0,s.kt)("p",null,"This policy is calling the PostgreSQL function we just created to get the currently logged in user's ID ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.user_id()")," and checking whether this matches the ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," column for the current ",(0,s.kt)("inlineCode",{parentName:"p"},"email"),". If it does, then it will allow the user to select it, otherwise it will continue to deny."),(0,s.kt)("p",null,"Click ",(0,s.kt)("inlineCode",{parentName:"p"},"Review")," and then ",(0,s.kt)("inlineCode",{parentName:"p"},"Save policy"),"."),(0,s.kt)("h3",{id:"insert-query-policy"},"INSERT query policy"),(0,s.kt)("p",null,"Our second policy will check whether the ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," being inserted is the same as the ",(0,s.kt)("inlineCode",{parentName:"p"},"userId")," in the JWT."),(0,s.kt)("p",null,"Create another policy and add the following:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Policy settings for INSERT",src:n(48157).Z,width:"2878",height:"1782"})),(0,s.kt)("p",null,"Similar to the previous policy we are calling the PostgreSQL function we created to get the currently logged in user's ID ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.user_id()")," and check whether this matches the ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," column for the row we are trying to insert. If it does, then it will allow the user to insert the row, otherwise it will continue to deny."),(0,s.kt)("p",null,"Click ",(0,s.kt)("inlineCode",{parentName:"p"},"Review")," and then ",(0,s.kt)("inlineCode",{parentName:"p"},"Save policy"),"."),(0,s.kt)("h2",{id:"step-9-test-your-changes"},"Step 9: Test your changes"),(0,s.kt)("p",null,"You can now sign up and you should see the following screen:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"SuperTokens App Authenticated",src:n(46566).Z,width:"2144",height:"192"})),(0,s.kt)("p",null,"If you navigate to your table you should see a new row with the user's ",(0,s.kt)("inlineCode",{parentName:"p"},"user_id")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"email"),"."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Supabase Users table",src:n(98338).Z,width:"3420",height:"1922"})),(0,s.kt)("h2",{id:"resources"},"Resources"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://supertokens.com/"},"SuperTokens")," official website."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://supertokens.com/discord"},"SuperTokens community"),"."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://supertokens.com/docs/guides"},"SuperTokens documentation"),".")))}c.isMDXComponent=!0},9330:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/create_policy-6c61ed2dee0def4ccbedf4b652c10db6.png"},48157:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/policy_config_insert-5b22d40ead84d0353d253959b11ef33e.png"},63473:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/policy_config_select-690025f2b8516e7ac3767e8494ab484a.png"},46566:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/supabase_app_authenticated_screen-fbdf10c8d4eb8ff0556b51dfa2a70663.png"},75696:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/supabase_dashboard_create-0ecf4c1ca05fa7e2621ceffdd6fe141b.png"},49145:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/supabase_table_create-57c9e8c43f56668412987b83b51d354e.png"},68198:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/supertokens_thirdpartyemailpassword_auth_screen-00e6d5a8f6d93589feda1656e9bcd0e5.png"},98338:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/table_with_user-1261328a5df6270eb7291245915e08f9.png"}}]);